<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Contract Management Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f7f9;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        .container {
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }
        .lang-switcher {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
        }
        .lang-switcher span {
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .lang-switcher span:hover, .lang-switcher span.active {
            opacity: 1;
        }
        fieldset {
            border: 1px solid #dcdcdc;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        legend {
            padding: 0 10px;
            font-weight: bold;
            color: #005a9c;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="number"], select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        button, .import-label {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover, .import-label:hover {
            background-color: #0056b3;
        }
        .import-label {
            display: inline-block;
        }
        #import-file, #import-templates {
            display: none;
        }
        .dynamic-list-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            cursor: pointer;
            line-height: 30px;
            text-align: center;
        }
        .remove-btn:hover {
            background-color: #c0392b;
        }
        .add-btn {
            background-color: #2ecc71;
            padding: 8px 12px;
            font-size: 14px;
        }
        .add-btn:hover {
            background-color: #27ae60;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        .autocomplete-active {
            background-color: #007bff !important;
            color: #ffffff;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="lang-switcher">
            <span id="lang-fr">üá´üá∑</span>
            <span id="lang-en" class="active">üá¨üáß</span>
        </div>

        <h1 data-lang="title">üñ®Ô∏è Printer Leasing Contract Tool</h1>

        <fieldset>
            <legend data-lang="templates">Contract Templates</legend>
            <div class="button-group" style="margin-top: 0;">
                <input type="file" id="import-templates" accept=".csv">
                <label for="import-templates" class="import-label" data-lang="importTemplatesBtn">üìÇ Import Templates (CSV)</label>
                <button type="button" id="download-template" data-lang="downloadTemplateBtn">üì• Download Template</button>
            </div>
        </fieldset>

        <div id="contract-form">
            <fieldset>
                <legend data-lang="generalInfo">General Information</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="contract-name" data-lang="contractName">Contract Name</label>
                        <input id="contract-name" type="text" data-lang-placeholder="contractNamePlaceholder" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="provider" data-lang="provider">Provider</label>
                        <input id="provider" type="text" data-lang-placeholder="providerPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="duration" data-lang="duration">Contract Duration (Months)</label>
                        <input id="duration" type="number" data-lang-placeholder="durationPlaceholder">
                    </div>
                </div>
            </fieldset>
            
            <fieldset>
                <legend data-lang="printerInfo">Printer Information</legend>
                 <div class="form-grid">
                    <div class="form-group">
                        <label for="manufacturer" data-lang="manufacturer">Manufacturer</label>
                        <input id="manufacturer" type="text" data-lang-placeholder="manufacturerPlaceholder" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="model" data-lang="model">Model</label>
                        <input id="model" type="text" data-lang-placeholder="modelPlaceholder" autocomplete="off">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="maintenance" data-lang="maintenance">Maintenance</label>
                        <input id="maintenance" type="number" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="reliability" data-lang="reliability">Reliability</label>
                        <input id="reliability" type="number" min="0" max="100">
                    </div>
                     <div class="form-group">
                        <label for="support" data-lang="support">Support</label>
                        <input id="support" type="number" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="easeOfUse" data-lang="easeOfUse">Ease of Use</label>
                        <input id="easeOfUse" type="number" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="repairability" data-lang="repairability">Repairability</label>
                        <input id="repairability" type="number" min="0" max="100">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend data-lang="coreCosts">Core Costs</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="base-cost" data-lang="baseCost">Base Monthly Cost (‚Ç¨)</label>
                        <input id="base-cost" type="number" step="0.01" data-lang-placeholder="baseCostPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="setup-fee" data-lang="setupFee">Setup Fee (‚Ç¨)</label>
                        <input id="setup-fee" type="number" step="0.01" data-lang-placeholder="setupFeePlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="delivery-fee" data-lang="deliveryFee">Delivery Fee (‚Ç¨)</label>
                        <input id="delivery-fee" type="number" step="0.01" data-lang-placeholder="deliveryFeePlaceholder">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend data-lang="pageCosts">Page Costs</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mono-included" data-lang="monoIncluded">Included Mono Pages</label>
                        <input id="mono-included" type="number" data-lang-placeholder="monoIncludedPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="mono-overrun" data-lang="monoOverrun">Mono Overrun Cost (‚Ç¨)</label>
                        <input id="mono-overrun" type="number" step="0.001" data-lang-placeholder="monoOverrunPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="color-included" data-lang="colorIncluded">Included Color Pages</label>
                        <input id="color-included" type="number" data-lang-placeholder="colorIncludedPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="color-overrun" data-lang="colorOverrun">Color Overrun Cost (‚Ç¨)</label>
                        <input id="color-overrun" type="number" step="0.001" data-lang-placeholder="colorOverrunPlaceholder">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend data-lang="extraCosts">Extra Costs</legend>
                <div id="extra-costs-list"></div>
                <button type="button" class="add-btn" id="add-extra-cost" data-lang="addExtraCost">Add Extra Cost</button>
            </fieldset>

            <fieldset>
                <legend data-lang="discounts">Discounts</legend>
                <div id="discounts-list"></div>
                <button type="button" class="add-btn" id="add-discount" data-lang="addDiscount">Add Discount</button>
            </fieldset>

            <div class="button-group">
                <button id="save-btn" data-lang="saveBtn">üíæ Save as JSON</button>
                <input type="file" id="import-file" accept=".json">
                <label for="import-file" class="import-label" data-lang="importBtn">üìÇ Import from JSON</label>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentLanguage = 'en';
        let customTemplates = [];

        const printerInfoData = {
            "Canon": {
                models: ["imageRUNNER ADVANCE DX C3800 Series", "imageRUNNER ADVANCE DX 6800 Series", "i-SENSYS X Series"],
                characteristics: { maintenance: 85, reliability: 90, support: 88, easeOfUse: 87, repairability: 80 }
            },
            "Toshiba": {
                models: ["e-STUDIO 7527AC", "e-STUDIO 6529A", "e-STUDIO 509CS"],
                characteristics: { maintenance: 85, reliability: 88, support: 80, easeOfUse: 87, repairability: 80 }
            },
            "Ricoh": {
                models: ["IM C Series", "IM Series"],
                characteristics: { maintenance: 82, reliability: 88, support: 80, easeOfUse: 89, repairability: 78 }
            },
            "Konica Minolta": {
                models: ["bizhub i-Series"],
                characteristics: { maintenance: 80, reliability: 90, support: 82, easeOfUse: 85, repairability: 75 }
            },
            "Koesio (Kyocera)": {
                models: ["TASKalfa Series", "ECOSYS Series"],
                characteristics: { maintenance: 85, reliability: 92, support: 85, easeOfUse: 85, repairability: 88 }
            },
             "Sharp": {
                models: ["MX-B/C Series"],
                characteristics: { maintenance: 70, reliability: 75, support: 60, easeOfUse: 80, repairability: 65 }
            },
            "Xerox": {
                models: ["AltaLink C8200/B8100 Series", "VersaLink C7100/B7100 Series"],
                characteristics: { maintenance: 65, reliability: 70, support: 55, easeOfUse: 85, repairability: 60 }
            },
            "HP": {
                models: ["LaserJet Enterprise M700/M800 Series", "PageWide Enterprise Series"],
                characteristics: { maintenance: 75, reliability: 80, support: 70, easeOfUse: 85, repairability: 70 }
            },
            "Epson": {
                models: ["WorkForce Enterprise Series", "WorkForce Pro Series"],
                characteristics: { maintenance: 88, reliability: 90, support: 85, easeOfUse: 87, repairability: 85 }
            }
        };

        const translations = {
            en: {
                title: 'üñ®Ô∏è Printer Leasing Contract Tool',
                templates: 'Contract Templates',
                importTemplatesBtn: 'üìÇ Import Templates (CSV)',
                downloadTemplateBtn: 'üì• Download Template',
                generalInfo: 'General Information',
                contractName: 'Contract Name',
                contractNamePlaceholder: 'e.g., Contract A (HP LaserJet Pro)',
                provider: 'Provider',
                providerPlaceholder: 'e.g., Printer Solutions Inc.',
                duration: 'Contract Duration (Months)',
                durationPlaceholder: 'e.g., 36',
                printerInfo: 'Printer Information',
                manufacturer: 'Manufacturer',
                manufacturerPlaceholder: 'e.g., Canon',
                model: 'Model',
                modelPlaceholder: 'e.g., imageRUNNER...',
                maintenance: 'Maintenance (0-100)',
                reliability: 'Reliability (0-100)',
                support: 'Support (0-100)',
                easeOfUse: 'Ease of Use (0-100)',
                repairability: 'Repairability (0-100)',
                coreCosts: 'Core Costs',
                baseCost: 'Base Monthly Cost (‚Ç¨)',
                baseCostPlaceholder: 'e.g., 50.00',
                setupFee: 'Setup Fee (‚Ç¨)',
                setupFeePlaceholder: 'e.g., 100.00',
                deliveryFee: 'Delivery Fee (‚Ç¨)',
                deliveryFeePlaceholder: 'e.g., 50.00',
                pageCosts: 'Page Costs',
                monoIncluded: 'Included Mono Pages',
                monoIncludedPlaceholder: 'e.g., 5000',
                monoOverrun: 'Mono Overrun Cost (‚Ç¨)',
                monoOverrunPlaceholder: 'e.g., 0.01',
                colorIncluded: 'Included Color Pages',
                colorIncludedPlaceholder: 'e.g., 1000',
                colorOverrun: 'Color Overrun Cost (‚Ç¨)',
                colorOverrunPlaceholder: 'e.g., 0.05',
                extraCosts: 'Extra Costs',
                addExtraCost: 'Add Extra Cost',
                discounts: 'Discounts',
                addDiscount: 'Add Discount',
                saveBtn: 'üíæ Save as JSON',
                importBtn: 'üìÇ Import from JSON',
                descriptionPlaceholder: 'Description',
                amountPlaceholder: 'Amount (‚Ç¨)',
                freqOneTime: 'One-Time',
                freqMonthly: 'Monthly',
                freqQuarterly: 'Quarterly',
                freqYearly: 'Yearly'
            },
            fr: {
                title: 'üñ®Ô∏è Outil de Contrat de Location d\'Imprimante',
                templates: 'Mod√®les de Contrat',
                importTemplatesBtn: 'üìÇ Importer des Mod√®les (CSV)',
                downloadTemplateBtn: 'üì• T√©l√©charger le Mod√®le',
                generalInfo: 'Informations G√©n√©rales',
                contractName: 'Nom du Contrat',
                contractNamePlaceholder: 'ex: Contrat A (HP LaserJet Pro)',
                provider: 'Fournisseur',
                providerPlaceholder: 'ex: Printer Solutions Inc.',
                duration: 'Dur√©e du Contrat (Mois)',
                durationPlaceholder: 'ex: 36',
                printerInfo: 'Informations sur l\'Imprimante',
                manufacturer: 'Fabricant',
                manufacturerPlaceholder: 'ex: Canon',
                model: 'Mod√®le',
                modelPlaceholder: 'ex: imageRUNNER...',
                maintenance: 'Maintenance (0-100)',
                reliability: 'Fiabilit√© (0-100)',
                support: 'Support (0-100)',
                easeOfUse: 'Facilit√© d\'Utilisation (0-100)',
                repairability: 'R√©parabilit√© (0-100)',
                coreCosts: 'Co√ªts de Base',
                baseCost: 'Co√ªt Mensuel de Base (‚Ç¨)',
                baseCostPlaceholder: 'ex: 50.00',
                setupFee: 'Frais d\'Installation (‚Ç¨)',
                setupFeePlaceholder: 'ex: 100.00',
                deliveryFee: 'Frais de Livraison (‚Ç¨)',
                deliveryFeePlaceholder: 'ex: 50.00',
                pageCosts: 'Co√ªts par Page',
                monoIncluded: 'Pages Mono Incluses',
                monoIncludedPlaceholder: 'ex: 5000',
                monoOverrun: 'Co√ªt D√©passement Mono (‚Ç¨)',
                monoOverrunPlaceholder: 'ex: 0.01',
                colorIncluded: 'Pages Couleur Incluses',
                colorIncludedPlaceholder: 'ex: 1000',
                colorOverrun: 'Co√ªt D√©passement Couleur (‚Ç¨)',
                colorOverrunPlaceholder: 'ex: 0.05',
                extraCosts: 'Co√ªts Suppl√©mentaires',
                addExtraCost: 'Ajouter un Co√ªt',
                discounts: 'R√©ductions',
                addDiscount: 'Ajouter une R√©duction',
                saveBtn: 'üíæ Sauvegarder en JSON',
                importBtn: 'üìÇ Importer depuis JSON',
                descriptionPlaceholder: 'Description',
                amountPlaceholder: 'Montant (‚Ç¨)',
                freqOneTime: 'Unique',
                freqMonthly: 'Mensuel',
                freqQuarterly: 'Trimestriel',
                freqYearly: 'Annuel'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                 if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            document.querySelectorAll('.dynamic-list-item').forEach(item => {
                item.querySelector('input[type="text"]').placeholder = translations[lang].descriptionPlaceholder;
                item.querySelector('input[type="number"]').placeholder = translations[lang].amountPlaceholder;
            });
             document.querySelectorAll('.lang-switcher span').forEach(span => span.classList.remove('active'));
             document.getElementById(`lang-${lang}`).classList.add('active');
        }

        document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));
        document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));

        function createDynamicRow(type) {
            const list = document.getElementById(`${type}-list`);
            const item = document.createElement('div');
            item.classList.add('dynamic-list-item');
            item.innerHTML = `
                <input type="text" class="${type}-desc" placeholder="${translations[currentLanguage].descriptionPlaceholder}">
                <input type="number" step="0.01" class="${type}-amount" placeholder="${translations[currentLanguage].amountPlaceholder}">
                <select class="${type}-freq">
                    <option value="one-time">${translations[currentLanguage].freqOneTime}</option>
                    <option value="monthly" selected>${translations[currentLanguage].freqMonthly}</option>
                    <option value="quarterly">${translations[currentLanguage].freqQuarterly}</option>
                    <option value="yearly">${translations[currentLanguage].freqYearly}</option>
                </select>
                <button type="button" class="remove-btn">X</button>
            `;
            list.appendChild(item);
            item.querySelector('.remove-btn').addEventListener('click', () => {
                item.remove();
            });
            return item;
        }

        document.getElementById('add-extra-cost').addEventListener('click', () => createDynamicRow('extra-costs'));
        document.getElementById('add-discount').addEventListener('click', () => createDynamicRow('discounts'));
        
        // --- TEMPLATE FUNCTIONALITY ---

        document.getElementById('download-template').addEventListener('click', () => {
            const headers = "name;provider;manufacturer;model;maintenance;reliability;support;easeOfUse;repairability;baseMonthlyCost;contractDurationMonths;includedPagesMonochrome;costPerPageMonochromeOverrun;includedPagesColor;costPerPageColorOverrun;setupFee;deliveryFee;extraCosts;discounts";
            
            // Field descriptions and current printer data for reference
            const fieldDescriptions = `# CSV Template for Contract Templates - Current Printer Database
# This template shows the current printer manufacturers and models available in autocomplete
# You can use this data as reference when creating your contract templates
# Below are all the current manufacturers, their models, and characteristics
#
# Current Available Manufacturers and Models:
# Canon: imageRUNNER ADVANCE DX C3800 Series, imageRUNNER ADVANCE DX 6800 Series, i-SENSYS X Series
# Toshiba: e-STUDIO 7527AC, e-STUDIO 6529A, e-STUDIO 509CS  
# Ricoh: IM C Series, IM Series
# Konica Minolta: bizhub i-Series
# Koesio (Kyocera): TASKalfa Series, ECOSYS Series
# Sharp: MX-B/C Series
# Xerox: AltaLink C8200/B8100 Series, VersaLink C7100/B7100 Series
# HP: LaserJet Enterprise M700/M800 Series, PageWide Enterprise Series
# Epson: WorkForce Enterprise Series, WorkForce Pro Series
#
# Characteristics by Manufacturer (Maintenance, Reliability, Support, Ease of Use, Repairability):
# Canon: 85, 90, 88, 87, 80
# Toshiba: 85, 88, 80, 87, 80
# Ricoh: 82, 88, 80, 89, 78
# Konica Minolta: 80, 90, 82, 85, 75
# Koesio (Kyocera): 85, 92, 85, 85, 88
# Sharp: 70, 75, 60, 80, 65
# Xerox: 65, 70, 55, 85, 60
# HP: 75, 80, 70, 85, 70
# Epson: 88, 90, 85, 87, 85
#
# Template Format Guide:
# name = Contract Name, provider = Provider Name, manufacturer = Use from list above
# model = Use models from manufacturer above, maintenance/reliability/support/easeOfUse/repairability = 0-100
# Costs in euros, durations in months, pages as numbers
# extraCosts/discounts = JSON format: [{"description":"Name","amount":0,"frequency":"monthly"}]
# Frequency options: "one-time", "monthly", "quarterly", "yearly"
#
`;
            
            // Generate templates using actual printer data
            let csvContent = fieldDescriptions + headers + '\n';
            
            // Create example templates for each manufacturer
            Object.keys(printerInfoData).forEach((manufacturer, index) => {
                const data = printerInfoData[manufacturer];
                const firstModel = data.models[0];
                const char = data.characteristics;
                const templateName = `Template ${String.fromCharCode(65 + index)} - ${manufacturer}`;
                const provider = `${manufacturer} Solutions Inc.`;
                const baseCost = 50 + (index * 25); // Vary costs for examples
                
                const templateRow = `${templateName};${provider};${manufacturer};${firstModel};${char.maintenance};${char.reliability};${char.support};${char.easeOfUse};${char.repairability};${baseCost}.00;36;5000;0.01${index};1000;0.0${5+index};100;50;[{"description":"Monthly support","amount":${15+index*5},"frequency":"monthly"}];[]`;
                csvContent += templateRow + '\n';
            });
            
            // Add empty template at the end
            csvContent += ';;;;;;;;;;;;;;;;;;[];[]';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "printer_database_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('import-templates').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.trim().split(/\r?\n/);
                    const headers = lines[0].split(';').map(h => h.trim());
                    customTemplates = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        const values = lines[i].split(';');
                        const entry = {};
                        for (let j = 0; j < headers.length; j++) {
                            entry[headers[j]] = values[j] ? values[j].trim() : '';
                        }
                        customTemplates.push(entry);
                    }
                    setupTemplateAutocomplete();
                    alert(`${customTemplates.length} templates loaded successfully!`);
                } catch (error) {
                    alert('Error parsing CSV file.');
                    console.error("Error parsing CSV:", error);
                }
            };
            reader.readAsText(file);
        });

        function applyTemplate(template) {
            if (!template) return;
            document.getElementById('contract-name').value = template.name || '';
            document.getElementById('provider').value = template.provider || '';
            document.getElementById('manufacturer').value = template.manufacturer || '';
            document.getElementById('model').value = template.model || '';
            document.getElementById('maintenance').value = template.maintenance || '';
            document.getElementById('reliability').value = template.reliability || '';
            document.getElementById('support').value = template.support || '';
            document.getElementById('easeOfUse').value = template.easeOfUse || '';
            document.getElementById('repairability').value = template.repairability || '';
            document.getElementById('base-cost').value = template.baseMonthlyCost || '';
            document.getElementById('duration').value = template.contractDurationMonths || '';
            document.getElementById('mono-included').value = template.includedPagesMonochrome || '';
            document.getElementById('mono-overrun').value = template.costPerPageMonochromeOverrun || '';
            document.getElementById('color-included').value = template.includedPagesColor || '';
            document.getElementById('color-overrun').value = template.costPerPageColorOverrun || '';
            document.getElementById('setup-fee').value = template.setupFee || '';
            document.getElementById('delivery-fee').value = template.deliveryFee || '';

            const populateDynamicList = (type, jsonString) => {
                const listContainer = document.getElementById(`${type}-list`);
                listContainer.innerHTML = '';
                try {
                    const dataList = JSON.parse(jsonString || '[]');
                    if (Array.isArray(dataList)) {
                        dataList.forEach(dataItem => {
                            const row = createDynamicRow(type);
                            row.querySelector(`.${type}-desc`).value = dataItem.description || '';
                            row.querySelector(`.${type}-amount`).value = dataItem.amount || '';
                            row.querySelector(`.${type}-freq`).value = dataItem.frequency || 'monthly';
                        });
                    }
                } catch (e) { console.error(`Failed to parse dynamic list from template: ${e}`) }
            };

            populateDynamicList('extra-costs', template.extraCosts);
            populateDynamicList('discounts', template.discounts);
        }

        function setupTemplateAutocomplete() {
            const inp = document.getElementById('contract-name');
            let currentFocus;

            const closeAllLists = (elmnt) => {
                const x = document.getElementsByClassName("autocomplete-items");
                for (let item of x) {
                    if (elmnt != item && elmnt != inp) {
                        item.parentNode.removeChild(item);
                    }
                }
            };
            
            inp.addEventListener("input", function() {
                let a, b, val = this.value;
                closeAllLists();
                if (!val || customTemplates.length === 0) { return false; }
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);

                for (let i = 0; i < customTemplates.length; i++) {
                    if (customTemplates[i].name.substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.innerHTML = `<strong>${customTemplates[i].name.substr(0, val.length)}</strong>${customTemplates[i].name.substr(val.length)}`;
                        b.dataset.templateIndex = i;
                        b.addEventListener("click", function() {
                            const selectedTemplate = customTemplates[this.dataset.templateIndex];
                            applyTemplate(selectedTemplate);
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });

            inp.addEventListener("keydown", function(e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) { // Down
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // Up
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1 && x) x[currentFocus].click();
                }
            });

            function addActive(x) {
                if (!x) return;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let item of x) item.classList.remove("autocomplete-active");
            }
            
            document.addEventListener("click", (e) => closeAllLists(e.target));
        }

        function setupGenericAutocomplete(inp, dataArray) {
             let currentFocus;

            const closeAllLists = (elmnt) => {
                const x = document.getElementsByClassName("autocomplete-items");
                for (let item of x) {
                    if (elmnt != item && elmnt != inp) {
                        item.parentNode.removeChild(item);
                    }
                }
            };
            
            inp.addEventListener("input", function() {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                for (i = 0; i < dataArray.length; i++) {
                    if (dataArray[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.innerHTML = "<strong>" + dataArray[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += dataArray[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + dataArray[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                            if(inp.id === 'manufacturer') {
                                handleManufacturerChange(inp.value);
                            }
                        });
                        a.appendChild(b);
                    }
                }
            });
            inp.addEventListener("keydown", function(e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) { // down
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // up
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
        }
        
        function handleManufacturerChange(manufacturerName) {
            const data = printerInfoData[manufacturerName];
            if(data) {
                document.getElementById('maintenance').value = data.characteristics.maintenance;
                document.getElementById('reliability').value = data.characteristics.reliability;
                document.getElementById('support').value = data.characteristics.support;
                document.getElementById('easeOfUse').value = data.characteristics.easeOfUse;
                document.getElementById('repairability').value = data.characteristics.repairability;
                setupGenericAutocomplete(document.getElementById('model'), data.models);
            }
        }

        setupGenericAutocomplete(document.getElementById('manufacturer'), Object.keys(printerInfoData));


        // --- SAVE FUNCTIONALITY ---
        document.getElementById('save-btn').addEventListener('click', () => {
            const getDynamicListData = (type) => {
                const items = [];
                document.querySelectorAll(`#${type}-list .dynamic-list-item`).forEach(item => {
                    const description = item.querySelector(`.${type}-desc`).value;
                    const amount = parseFloat(item.querySelector(`.${type}-amount`).value);
                    const frequency = item.querySelector(`.${type}-freq`).value;
                    if (description && !isNaN(amount)) {
                        items.push({ description, amount, frequency });
                    }
                });
                return items;
            };

            const contractData = {
                id: `contract-${crypto.randomUUID()}`,
                name: document.getElementById('contract-name').value,
                provider: document.getElementById('provider').value,
                printerInfo: {
                    manufacturer: document.getElementById('manufacturer').value,
                    model: document.getElementById('model').value,
                    maintenance: parseInt(document.getElementById('maintenance').value) || 0,
                    reliability: parseInt(document.getElementById('reliability').value) || 0,
                    support: parseInt(document.getElementById('support').value) || 0,
                    easeOfUse: parseInt(document.getElementById('easeOfUse').value) || 0,
                    repairability: parseInt(document.getElementById('repairability').value) || 0,
                },
                baseMonthlyCost: parseFloat(document.getElementById('base-cost').value) || 0,
                contractDurationMonths: parseInt(document.getElementById('duration').value) || 0,
                includedPagesMonochrome: parseInt(document.getElementById('mono-included').value) || 0,
                costPerPageMonochromeOverrun: parseFloat(document.getElementById('mono-overrun').value) || 0,
                includedPagesColor: parseInt(document.getElementById('color-included').value) || 0,
                costPerPageColorOverrun: parseFloat(document.getElementById('color-overrun').value) || 0,
                setupFee: parseFloat(document.getElementById('setup-fee').value) || 0,
                deliveryFee: parseFloat(document.getElementById('delivery-fee').value) || 0,
                extraCosts: getDynamicListData('extra-costs'),
                discounts: getDynamicListData('discounts')
            };

            const dataStr = JSON.stringify(contractData, null, 4);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `${contractData.name.replace(/[^a-z0-9]/gi, '_') || 'contract'}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });

        // --- IMPORT FUNCTIONALITY ---
        document.getElementById('import-file').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    document.getElementById('contract-name').value = data.name || '';
                    document.getElementById('provider').value = data.provider || '';
                    if(data.printerInfo) {
                        document.getElementById('manufacturer').value = data.printerInfo.manufacturer || '';
                        document.getElementById('model').value = data.printerInfo.model || '';
                        document.getElementById('maintenance').value = data.printerInfo.maintenance || '';
                        document.getElementById('reliability').value = data.printerInfo.reliability || '';
                        document.getElementById('support').value = data.printerInfo.support || '';
                        document.getElementById('easeOfUse').value = data.printerInfo.easeOfUse || '';
                        document.getElementById('repairability').value = data.printerInfo.repairability || '';
                    }
                    document.getElementById('base-cost').value = data.baseMonthlyCost || '';
                    document.getElementById('duration').value = data.contractDurationMonths || '';
                    document.getElementById('mono-included').value = data.includedPagesMonochrome || '';
                    document.getElementById('mono-overrun').value = data.costPerPageMonochromeOverrun || '';
                    document.getElementById('color-included').value = data.includedPagesColor || '';
                    document.getElementById('color-overrun').value = data.costPerPageColorOverrun || '';
                    document.getElementById('setup-fee').value = data.setupFee || '';
                    document.getElementById('delivery-fee').value = data.deliveryFee || '';

                    const populateDynamicList = (type, dataList) => {
                        const listContainer = document.getElementById(`${type}-list`);
                        listContainer.innerHTML = '';
                        if (dataList && Array.isArray(dataList)) {
                            dataList.forEach(dataItem => {
                                const row = createDynamicRow(type);
                                row.querySelector(`.${type}-desc`).value = dataItem.description || '';
                                row.querySelector(`.${type}-amount`).value = dataItem.amount || '';
                                row.querySelector(`.${type}-freq`).value = dataItem.frequency || 'monthly';
                            });
                        }
                    };
                    
                    populateDynamicList('extra-costs', data.extraCosts);
                    populateDynamicList('discounts', data.discounts);

                } catch (error) {
                    alert('Error: Could not parse the JSON file.');
                    console.error("Error parsing JSON:", error);
                }
            };
            reader.readAsText(file);
        });
        
        // Set initial language
        setLanguage(currentLanguage);
        setupTemplateAutocomplete();
    });
    </script>
</body>
</html>
