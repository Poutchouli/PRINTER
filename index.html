<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Contract Management Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f7f9;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        .container {
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }
        .lang-switcher {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
        }
        .lang-switcher span {
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .lang-switcher span:hover, .lang-switcher span.active {
            opacity: 1;
        }
        fieldset {
            border: 1px solid #dcdcdc;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        legend {
            padding: 0 10px;
            font-weight: bold;
            color: #005a9c;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="number"], select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        button, .import-label {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover, .import-label:hover {
            background-color: #0056b3;
        }
        .import-label {
            display: inline-block;
        }
        #import-templates, #import-json-contract {
            display: none;
        }
        .dynamic-list-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            cursor: pointer;
            line-height: 30px;
            text-align: center;
        }
        .remove-btn:hover {
            background-color: #c0392b;
        }
        .add-btn {
            background-color: #2ecc71;
            padding: 8px 12px;
            font-size: 14px;
        }
        .add-btn:hover {
            background-color: #27ae60;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        .autocomplete-active {
            background-color: #007bff !important;
            color: #ffffff;
        }
        
        /* Additional form styling for Windows */
        .form-group {
            position: relative;
        }
        
        /* Error display styles */
        .error-message {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }
        
        /* Drag and Drop Zone Styles */
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin: 15px 0;
            background-color: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .drop-zone:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        
        .drop-zone.drag-over {
            border-color: #007bff;
            background-color: #e3f2fd;
            transform: scale(1.02);
        }
        
        .drop-zone.processing {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .drop-zone.success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .drop-zone.error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
        
        .drop-zone-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .drop-zone-subtext {
            font-size: 14px;
            color: #6c757d;
        }
        
        .file-preview {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        
        .file-preview.show {
            display: block;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="lang-switcher">
            <span id="lang-fr">üá´üá∑</span>
            <span id="lang-en" class="active">üá¨üáß</span>
        </div>

        <h1 data-lang="title">üñ®Ô∏è Printer Leasing Contract Tool</h1>

        <fieldset>
            <legend data-lang="templates">Contract Templates & Import</legend>
            
            <!-- Drag and Drop Zone -->
            <div class="drop-zone" id="file-drop-zone">
                <span class="drop-zone-icon">üìÅ</span>
                <div class="drop-zone-text" data-lang="dropZoneText">Drag & Drop Files Here</div>
                <div class="drop-zone-subtext" data-lang="dropZoneSubtext">or click to browse (.json, .csv files)</div>
                <div class="file-preview" id="file-preview"></div>
            </div>
            
            <!-- Traditional File Input Buttons -->
            <div class="button-group" style="margin-top: 15px;">
                <input type="file" id="import-templates" accept=".csv">
                <label for="import-templates" class="import-label" data-lang="importTemplatesBtn">üìÇ Import Templates (CSV)</label>
                <input type="file" id="import-json-contract" accept=".json">
                <label for="import-json-contract" class="import-label" data-lang="importJsonBtn">üìÑ Import Contract (JSON)</label>
                <button type="button" id="download-template" data-lang="downloadTemplateBtn">üì• Download Template</button>
            </div>
        </fieldset>

        <div id="contract-form">
            <fieldset>
                <legend data-lang="generalInfo">General Information</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="contract-name" data-lang="contractName">Contract Name</label>
                        <input id="contract-name" type="text" data-lang-placeholder="contractNamePlaceholder" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="provider" data-lang="provider">Provider</label>
                        <input id="provider" type="text" data-lang-placeholder="providerPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="duration" data-lang="duration">Contract Duration (Months)</label>
                        <input id="duration" type="number" data-lang-placeholder="durationPlaceholder">
                    </div>
                </div>
            </fieldset>
            
            <fieldset>
                <legend data-lang="printerInfo">Printer Information</legend>
                 <div class="form-grid">
                    <div class="form-group">
                        <label for="manufacturer" data-lang="manufacturer">Manufacturer</label>
                        <input id="manufacturer" type="text" data-lang-placeholder="manufacturerPlaceholder" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="model" data-lang="model">Model</label>
                        <input id="model" type="text" data-lang-placeholder="modelPlaceholder" autocomplete="off">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="maintenance" data-lang="maintenance">Maintenance</label>
                        <input id="maintenance" type="number" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="reliability" data-lang="reliability">Reliability</label>
                        <input id="reliability" type="number" min="0" max="100">
                    </div>
                     <div class="form-group">
                        <label for="support" data-lang="support">Support</label>
                        <input id="support" type="number" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="easeOfUse" data-lang="easeOfUse">Ease of Use</label>
                        <input id="easeOfUse" type="number" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="repairability" data-lang="repairability">Repairability</label>
                        <input id="repairability" type="number" min="0" max="100">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend data-lang="coreCosts">Core Costs</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="base-cost" data-lang="baseCost">Base Monthly Cost (‚Ç¨)</label>
                        <input id="base-cost" type="number" step="0.01" data-lang-placeholder="baseCostPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="setup-fee" data-lang="setupFee">Setup Fee (‚Ç¨)</label>
                        <input id="setup-fee" type="number" step="0.01" data-lang-placeholder="setupFeePlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="delivery-fee" data-lang="deliveryFee">Delivery Fee (‚Ç¨)</label>
                        <input id="delivery-fee" type="number" step="0.01" data-lang-placeholder="deliveryFeePlaceholder">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend data-lang="pageCosts">Page Costs</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mono-included" data-lang="monoIncluded">Included Mono Pages</label>
                        <input id="mono-included" type="number" data-lang-placeholder="monoIncludedPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="mono-overrun" data-lang="monoOverrun">Mono Overrun Cost (‚Ç¨)</label>
                        <input id="mono-overrun" type="number" step="0.001" data-lang-placeholder="monoOverrunPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="color-included" data-lang="colorIncluded">Included Color Pages</label>
                        <input id="color-included" type="number" data-lang-placeholder="colorIncludedPlaceholder">
                    </div>
                    <div class="form-group">
                        <label for="color-overrun" data-lang="colorOverrun">Color Overrun Cost (‚Ç¨)</label>
                        <input id="color-overrun" type="number" step="0.001" data-lang-placeholder="colorOverrunPlaceholder">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend data-lang="extraCosts">Extra Costs</legend>
                <div id="extra-costs-list"></div>
                <button type="button" class="add-btn" id="add-extra-cost" data-lang="addExtraCost">Add Extra Cost</button>
            </fieldset>

            <fieldset>
                <legend data-lang="discounts">Discounts</legend>
                <div id="discounts-list"></div>
                <button type="button" class="add-btn" id="add-discount" data-lang="addDiscount">Add Discount</button>
            </fieldset>

            <div class="button-group">
                <button id="save-btn" data-lang="saveBtn">üíæ Save as JSON</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript Modules -->
    <script src="js/logger.js"></script>
    <script src="js/module-registry.js"></script>
    <script src="js/translation-manager.js"></script>
    <script src="js/printer-database.js"></script>
    <script src="js/autocomplete-manager.js"></script>
    <script src="js/template-manager.js"></script>
    <script src="js/form-manager.js"></script>
    <script src="js/debug-panel.js"></script>

    <!-- Application Initialization -->
    <script>
    // Initialize global logger and module registry with detailed error checking
    console.log('=== JavaScript Module Loading Debug ===');
    
    // Check if classes are defined
    console.log('Logger class available:', typeof Logger);
    console.log('ModuleRegistry class available:', typeof ModuleRegistry);
    console.log('TranslationManager class available:', typeof TranslationManager);
    console.log('PrinterDatabase class available:', typeof PrinterDatabase);
    console.log('AutocompleteManager class available:', typeof AutocompleteManager);
    console.log('TemplateManager class available:', typeof TemplateManager);
    console.log('FormManager class available:', typeof FormManager);
    console.log('DebugPanel class available:', typeof DebugPanel);
    
    // Create application namespace to avoid conflicts
    window.PrinterApp = {};
    
    try {
        console.log('Creating AppLogger instance...');
        window.PrinterApp.logger = new Logger();
        // Keep backward compatibility
        window.AppLogger = window.PrinterApp.logger;
        console.log('‚úì AppLogger created successfully');
        console.log('AppLogger type:', typeof window.AppLogger);
    } catch (error) {
        console.error('‚úó Failed to create AppLogger:', error.message, error.stack);
        throw new Error('AppLogger initialization failed: ' + error.message);
    }
    
    try {
        console.log('Creating ModuleRegistry instance...');
        window.PrinterApp.moduleRegistry = new ModuleRegistry();
        // Keep backward compatibility
        window.ModuleRegistry = window.PrinterApp.moduleRegistry;
        console.log('‚úì ModuleRegistry created successfully');
        console.log('ModuleRegistry type:', typeof window.ModuleRegistry);
        console.log('ModuleRegistry.register type:', typeof window.ModuleRegistry.register);
    } catch (error) {
        console.error('‚úó Failed to create ModuleRegistry:', error.message, error.stack);
        throw new Error('ModuleRegistry initialization failed: ' + error.message);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('=== DOM Content Loaded - Starting App Initialization ===');
        try {
            AppLogger.info('App', 'Starting Printer Contract Management Tool');
            console.log('‚úì AppLogger.info() call successful');

            // Register all modules with detailed error checking
            console.log('=== Module Registration Phase ===');
            
            try {
                console.log('1. Registering TranslationManager...');
                
                // Debug: Check ModuleRegistry before use
                console.log('   - Checking ModuleRegistry before use:');
                console.log('   - typeof ModuleRegistry:', typeof ModuleRegistry);
                console.log('   - ModuleRegistry.register:', typeof ModuleRegistry.register);
                console.log('   - typeof PrinterApp.moduleRegistry:', typeof PrinterApp.moduleRegistry);
                console.log('   - PrinterApp.moduleRegistry.register:', typeof PrinterApp.moduleRegistry.register);
                
                const translationManager = new TranslationManager();
                console.log('   ‚úì TranslationManager instance created');
                
                // Use the namespace reference to avoid scoping issues
                PrinterApp.moduleRegistry.register('TranslationManager', {
                    version: '1.0.0',
                    description: 'Handles internationalization and language switching',
                    instance: translationManager,
                    dependencies: []
                });
                console.log('   ‚úì TranslationManager registered successfully');
            } catch (error) {
                console.error('   ‚úó TranslationManager registration failed:', error.message, error.stack);
                throw new Error('TranslationManager registration failed: ' + error.message);
            }

            try {
                console.log('2. Registering PrinterDatabase...');
                const printerDatabase = new PrinterDatabase();
                console.log('   ‚úì PrinterDatabase instance created');
                PrinterApp.moduleRegistry.register('PrinterDatabase', {
                    version: '1.0.0',
                    description: 'Manages printer manufacturer and model data',
                    instance: printerDatabase,
                    dependencies: []
                });
                console.log('   ‚úì PrinterDatabase registered successfully');
            } catch (error) {
                console.error('   ‚úó PrinterDatabase registration failed:', error.message, error.stack);
                throw new Error('PrinterDatabase registration failed: ' + error.message);
            }

            try {
                console.log('3. Registering AutocompleteManager...');
                const autocompleteManager = new AutocompleteManager();
                console.log('   ‚úì AutocompleteManager instance created');
                PrinterApp.moduleRegistry.register('AutocompleteManager', {
                    version: '1.0.0',
                    description: 'Handles autocomplete functionality for form fields',
                    instance: autocompleteManager,
                    dependencies: ['PrinterDatabase']
                });
                console.log('   ‚úì AutocompleteManager registered successfully');
            } catch (error) {
                console.error('   ‚úó AutocompleteManager registration failed:', error.message, error.stack);
                throw new Error('AutocompleteManager registration failed: ' + error.message);
            }

            try {
                console.log('4. Registering TemplateManager...');
                const templateManager = new TemplateManager();
                console.log('   ‚úì TemplateManager instance created');
                PrinterApp.moduleRegistry.register('TemplateManager', {
                    version: '1.0.0',
                    description: 'Manages template loading, saving, and CSV operations',
                    instance: templateManager,
                    dependencies: ['PrinterDatabase', 'AutocompleteManager']
                });
                console.log('   ‚úì TemplateManager registered successfully');
            } catch (error) {
                console.error('   ‚úó TemplateManager registration failed:', error.message, error.stack);
                throw new Error('TemplateManager registration failed: ' + error.message);
            }

            try {
                console.log('5. Registering FormManager...');
                const formManager = new FormManager();
                console.log('   ‚úì FormManager instance created');
                PrinterApp.moduleRegistry.register('FormManager', {
                    version: '1.0.0',
                    description: 'Handles form interactions, validation, and file operations',
                    instance: formManager,
                    dependencies: ['TranslationManager', 'TemplateManager']
                });
                console.log('   ‚úì FormManager registered successfully');
            } catch (error) {
                console.error('   ‚úó FormManager registration failed:', error.message, error.stack);
                throw new Error('FormManager registration failed: ' + error.message);
            }

            try {
                console.log('6. Registering DebugPanel...');
                const debugPanel = new DebugPanel();
                console.log('   ‚úì DebugPanel instance created');
                PrinterApp.moduleRegistry.register('DebugPanel', {
                    version: '1.0.0',
                    description: 'Provides debug panel for system introspection',
                    instance: debugPanel,
                    dependencies: []
                });
                console.log('   ‚úì DebugPanel registered successfully');
            } catch (error) {
                console.error('   ‚úó DebugPanel registration failed:', error.message, error.stack);
                throw new Error('DebugPanel registration failed: ' + error.message);
            }

            // Initialize all modules in dependency order
            console.log('=== Module Initialization Phase ===');
            try {
                console.log('Starting module initialization...');
                await PrinterApp.moduleRegistry.initializeAll();
                console.log('‚úì All modules initialized successfully!');
            } catch (error) {
                console.error('‚úó Module initialization failed:', error.message, error.stack);
                throw new Error('Module initialization failed: ' + error.message);
            }

            // Set up global error handling
            window.addEventListener('error', (event) => {
                AppLogger.error('Global', 'Unhandled JavaScript error', {
                    message: event.message,
                    filename: event.filename,
                    line: event.lineno,
                    column: event.colno,
                    stack: event.error?.stack
                });
            });

            window.addEventListener('unhandledrejection', (event) => {
                AppLogger.error('Global', 'Unhandled promise rejection', {
                    reason: event.reason,
                    promise: event.promise
                });
            });

            AppLogger.info('App', 'Application initialized successfully');

            // Quick fix: Set up basic autocomplete manually if modules failed
            setTimeout(() => {
                try {
                    console.log('Setting up fallback autocomplete...');
                    
                    // Set up manufacturer autocomplete
                    const manufacturerInput = document.getElementById('manufacturer');
                    if (manufacturerInput) {
                        const manufacturers = ['Canon', 'Toshiba', 'Ricoh', 'Konica Minolta', 'Koesio (Kyocera)', 'Sharp', 'Xerox', 'HP', 'Epson'];
                        setupSimpleAutocomplete(manufacturerInput, manufacturers);
                        console.log('Manufacturer autocomplete set up');
                    }

                    // Ensure placeholders are set
                    const translationManager = PrinterApp.moduleRegistry.getModule('TranslationManager');
                    if (translationManager) {
                        console.log('TranslationManager initialized:', translationManager.initialized);
                        console.log('Available languages:', translationManager.getSupportedLanguages());
                        console.log('Current language:', translationManager.getCurrentLanguage());
                        
                        // Check if the translation manager is initialized
                        if (!translationManager.initialized) {
                            console.log('TranslationManager not initialized yet, calling init()...');
                            translationManager.init().then(() => {
                                translationManager.setLanguage('en');
                                console.log('Language set to English');
                            }).catch(error => {
                                console.error('Failed to initialize TranslationManager:', error);
                            });
                        } else {
                            try {
                                translationManager.setLanguage('en');
                                console.log('Language set to English');
                            } catch (error) {
                                console.error('Failed to set language:', error);
                                console.log('Available translations keys:', Object.keys(translationManager.translations));
                            }
                        }
                    }
                    
                    // Set up language switchers
                    const langFr = document.getElementById('lang-fr');
                    const langEn = document.getElementById('lang-en');
                    
                    if (langFr && translationManager) {
                        langFr.addEventListener('click', () => {
                            translationManager.setLanguage('fr');
                            console.log('Language switched to French');
                        });
                    }
                    if (langEn && translationManager) {
                        langEn.addEventListener('click', () => {
                            translationManager.setLanguage('en');
                            console.log('Language switched to English');
                        });
                    }
                    
                    console.log('Language switchers set up');
                    
                    // Set up save button fallback
                    const saveBtn = document.getElementById('save-btn');
                    if (saveBtn) {
                        // Check if FormManager is working
                        const formManager = PrinterApp.moduleRegistry?.getModule('FormManager');
                        if (!formManager || !formManager.initialized) {
                            console.log('FormManager not available, setting up fallback save functionality');
                            saveBtn.addEventListener('click', () => {
                                try {
                                    console.log('Fallback save button clicked');
                                    
                                    // Get form data directly
                                    const contractData = {
                                        contractName: document.getElementById('contract-name')?.value || '',
                                        provider: document.getElementById('provider')?.value || '',
                                        duration: parseInt(document.getElementById('duration')?.value) || 0,
                                        manufacturer: document.getElementById('manufacturer')?.value || '',
                                        model: document.getElementById('model')?.value || '',
                                        maintenance: parseInt(document.getElementById('maintenance')?.value) || 0,
                                        reliability: parseInt(document.getElementById('reliability')?.value) || 0,
                                        support: parseInt(document.getElementById('support')?.value) || 0,
                                        easeOfUse: parseInt(document.getElementById('easeOfUse')?.value) || 0,
                                        repairability: parseInt(document.getElementById('repairability')?.value) || 0,
                                        baseCost: parseFloat(document.getElementById('base-cost')?.value) || 0,
                                        setupFee: parseFloat(document.getElementById('setup-fee')?.value) || 0,
                                        deliveryFee: parseFloat(document.getElementById('delivery-fee')?.value) || 0,
                                        monoIncluded: parseInt(document.getElementById('mono-included')?.value) || 0,
                                        monoOverrun: parseFloat(document.getElementById('mono-overrun')?.value) || 0,
                                        colorIncluded: parseInt(document.getElementById('color-included')?.value) || 0,
                                        colorOverrun: parseFloat(document.getElementById('color-overrun')?.value) || 0,
                                        extraCosts: [],
                                        discounts: [],
                                        createdAt: new Date().toISOString()
                                    };
                                    
                                    // Get dynamic lists data
                                    const extraCostsList = document.getElementById('extra-costs-list');
                                    if (extraCostsList) {
                                        const extraCostItems = extraCostsList.querySelectorAll('.dynamic-list-item');
                                        extraCostItems.forEach(item => {
                                            const desc = item.querySelector('.extra-costs-desc')?.value || '';
                                            const amount = parseFloat(item.querySelector('.extra-costs-amount')?.value) || 0;
                                            const frequency = item.querySelector('.extra-costs-freq')?.value || 'monthly';
                                            if (desc.trim()) {
                                                contractData.extraCosts.push({ description: desc, amount: amount, frequency: frequency });
                                            }
                                        });
                                    }
                                    
                                    const discountsList = document.getElementById('discounts-list');
                                    if (discountsList) {
                                        const discountItems = discountsList.querySelectorAll('.dynamic-list-item');
                                        discountItems.forEach(item => {
                                            const desc = item.querySelector('.discounts-desc')?.value || '';
                                            const amount = parseFloat(item.querySelector('.discounts-amount')?.value) || 0;
                                            const frequency = item.querySelector('.discounts-freq')?.value || 'monthly';
                                            if (desc.trim()) {
                                                contractData.discounts.push({ description: desc, amount: amount, frequency: frequency });
                                            }
                                        });
                                    }
                                    
                                    // Validate and save
                                    if (!contractData.contractName.trim()) {
                                        alert('Contract name is required');
                                        return;
                                    }
                                    
                                    const dataStr = JSON.stringify(contractData, null, 2);
                                    const filename = contractData.contractName.replace(/[^a-z0-9]/gi, '_') + '.json';
                                    
                                    // Create download
                                    const blob = new Blob([dataStr], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    a.style.visibility = 'hidden';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                    
                                    console.log('Contract saved successfully using fallback method');
                                } catch (error) {
                                    console.error('Fallback save failed:', error);
                                    alert('Failed to save contract: ' + error.message);
                                }
                            });
                        }
                    }
                    
                    console.log('Save button fallback set up');
                    // Set up dynamic list buttons
                    const addExtraCostBtn = document.getElementById('add-extra-cost');
                    const addDiscountBtn = document.getElementById('add-discount');
                    
                    if (addExtraCostBtn) {
                        addExtraCostBtn.addEventListener('click', () => createDynamicRow('extra-costs'));
                    }
                    if (addDiscountBtn) {
                        addDiscountBtn.addEventListener('click', () => createDynamicRow('discounts'));
                    }
                    
                    console.log('Dynamic list buttons set up');
                } catch (error) {
                    console.error('Fallback setup failed:', error);
                }
            }, 1000);

            // Dynamic row creation function
            function createDynamicRow(type) {
                const list = document.getElementById(type + '-list');
                const item = document.createElement('div');
                item.classList.add('dynamic-list-item');
                item.innerHTML = 
                    '<input type="text" class="' + type + '-desc" placeholder="Description">' +
                    '<input type="number" step="0.01" class="' + type + '-amount" placeholder="Amount (‚Ç¨)">' +
                    '<select class="' + type + '-freq">' +
                        '<option value="one-time">One-Time</option>' +
                        '<option value="monthly" selected>Monthly</option>' +
                        '<option value="quarterly">Quarterly</option>' +
                        '<option value="yearly">Yearly</option>' +
                    '</select>' +
                    '<button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>';
                list.appendChild(item);
                return item;
            }

            // Simple autocomplete function
            function setupSimpleAutocomplete(input, dataArray) {
                input.addEventListener('input', function() {
                    const val = this.value;
                    
                    // Remove existing dropdown
                    const existing = input.parentNode.querySelector('.autocomplete-items');
                    if (existing) existing.remove();
                    
                    if (!val) return;
                    
                    const dropdown = document.createElement('div');
                    dropdown.className = 'autocomplete-items';
                    dropdown.style.cssText = 'position: absolute; border: 1px solid #d4d4d4; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background-color: #fff;';
                    
                    dataArray.forEach(item => {
                        if (item.toLowerCase().includes(val.toLowerCase())) {
                            const itemDiv = document.createElement('div');
                            itemDiv.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid #d4d4d4;';
                            itemDiv.textContent = item;
                            itemDiv.addEventListener('click', () => {
                                input.value = item;
                                dropdown.remove();
                                
                                // Handle manufacturer selection
                                if (input.id === 'manufacturer') {
                                    const printerData = {
                                        "Canon": { maintenance: 85, reliability: 90, support: 88, easeOfUse: 87, repairability: 80 },
                                        "Toshiba": { maintenance: 85, reliability: 88, support: 80, easeOfUse: 87, repairability: 80 },
                                        "Ricoh": { maintenance: 82, reliability: 88, support: 80, easeOfUse: 89, repairability: 78 },
                                        "Konica Minolta": { maintenance: 80, reliability: 90, support: 82, easeOfUse: 85, repairability: 75 },
                                        "Koesio (Kyocera)": { maintenance: 85, reliability: 92, support: 85, easeOfUse: 85, repairability: 88 },
                                        "Sharp": { maintenance: 70, reliability: 75, support: 60, easeOfUse: 80, repairability: 65 },
                                        "Xerox": { maintenance: 65, reliability: 70, support: 55, easeOfUse: 85, repairability: 60 },
                                        "HP": { maintenance: 75, reliability: 80, support: 70, easeOfUse: 85, repairability: 70 },
                                        "Epson": { maintenance: 88, reliability: 90, support: 85, easeOfUse: 87, repairability: 85 }
                                    };
                                    
                                    const data = printerData[item];
                                    if (data) {
                                        document.getElementById('maintenance').value = data.maintenance;
                                        document.getElementById('reliability').value = data.reliability;
                                        document.getElementById('support').value = data.support;
                                        document.getElementById('easeOfUse').value = data.easeOfUse;
                                        document.getElementById('repairability').value = data.repairability;
                                    }
                                }
                            });
                            dropdown.appendChild(itemDiv);
                        }
                    });
                    
                    if (dropdown.children.length > 0) {
                        input.parentNode.style.position = 'relative';
                        input.parentNode.appendChild(dropdown);
                    }
                });
            }

            // Drag and Drop functionality
            function setupDragAndDrop() {
                const dropZone = document.getElementById('file-drop-zone');
                const filePreview = document.getElementById('file-preview');
                const csvInput = document.getElementById('import-templates');
                const jsonInput = document.getElementById('import-json-contract');

                if (!dropZone) return;

                // Click to browse
                dropZone.addEventListener('click', () => {
                    // Create a temporary input to let user choose file type
                    const tempInput = document.createElement('input');
                    tempInput.type = 'file';
                    tempInput.accept = '.json,.csv';
                    tempInput.onchange = (e) => handleFileSelection(e.target.files);
                    tempInput.click();
                });

                // Drag and drop events
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    if (!dropZone.contains(e.relatedTarget)) {
                        dropZone.classList.remove('drag-over');
                    }
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    handleFileSelection(e.dataTransfer.files);
                });

                function handleFileSelection(files) {
                    if (files.length === 0) return;

                    const file = files[0];
                    const fileName = file.name.toLowerCase();
                    
                    // Show processing state
                    dropZone.classList.add('processing');
                    filePreview.innerHTML = '<strong>Processing:</strong> ' + file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)';
                    filePreview.classList.add('show');

                    // Reset states
                    dropZone.classList.remove('success', 'error');

                    if (fileName.endsWith('.csv')) {
                        // Handle CSV file
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                // Trigger the CSV import through the template manager
                                const templateManager = PrinterApp.moduleRegistry?.getModule('TemplateManager');
                                if (templateManager && templateManager.importTemplates) {
                                    templateManager.importTemplates(e.target.result);
                                    showDropZoneSuccess('CSV imported successfully: ' + file.name);
                                } else {
                                    // Fallback CSV handling
                                    console.log('CSV content:', e.target.result);
                                    showDropZoneSuccess('CSV loaded: ' + file.name + ' (fallback mode)');
                                }
                            } catch (error) {
                                console.error('CSV import error:', error);
                                showDropZoneError('Failed to import CSV: ' + error.message);
                            }
                        };
                        reader.onerror = () => showDropZoneError('Failed to read CSV file: ' + file.name);
                        reader.readAsText(file);

                    } else if (fileName.endsWith('.json')) {
                        // Handle JSON file
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const contractData = JSON.parse(e.target.result);
                                
                                // Populate form with contract data
                                populateFormFromJSON(contractData);
                                showDropZoneSuccess('Contract imported successfully: ' + file.name);
                            } catch (error) {
                                console.error('JSON import error:', error);
                                showDropZoneError('Failed to import JSON: ' + error.message);
                            }
                        };
                        reader.onerror = () => showDropZoneError('Failed to read JSON file: ' + file.name);
                        reader.readAsText(file);

                    } else {
                        showDropZoneError('Unsupported file type. Please use .json or .csv files.');
                    }
                }

                function populateFormFromJSON(data) {
                    // Populate basic fields
                    const fieldMappings = {
                        'contract-name': 'contractName',
                        'provider': 'provider',
                        'duration': 'duration',
                        'manufacturer': 'manufacturer',
                        'model': 'model',
                        'maintenance': 'maintenance',
                        'reliability': 'reliability',
                        'support': 'support',
                        'easeOfUse': 'easeOfUse',
                        'repairability': 'repairability',
                        'base-cost': 'baseCost',
                        'setup-fee': 'setupFee',
                        'delivery-fee': 'deliveryFee',
                        'mono-included': 'monoIncluded',
                        'mono-overrun': 'monoOverrun',
                        'color-included': 'colorIncluded',
                        'color-overrun': 'colorOverrun'
                    };

                    Object.entries(fieldMappings).forEach(([fieldId, dataKey]) => {
                        const element = document.getElementById(fieldId);
                        if (element && data[dataKey] !== undefined) {
                            element.value = data[dataKey];
                        }
                    });

                    // Handle extra costs
                    const extraCostsList = document.getElementById('extra-costs-list');
                    if (extraCostsList && data.extraCosts) {
                        extraCostsList.innerHTML = '';
                        data.extraCosts.forEach(cost => {
                            const item = createDynamicRow('extra-costs');
                            item.querySelector('.extra-costs-desc').value = cost.description || '';
                            item.querySelector('.extra-costs-amount').value = cost.amount || '';
                            item.querySelector('.extra-costs-freq').value = cost.frequency || 'monthly';
                        });
                    }

                    // Handle discounts
                    const discountsList = document.getElementById('discounts-list');
                    if (discountsList && data.discounts) {
                        discountsList.innerHTML = '';
                        data.discounts.forEach(discount => {
                            const item = createDynamicRow('discounts');
                            item.querySelector('.discounts-desc').value = discount.description || '';
                            item.querySelector('.discounts-amount').value = discount.amount || '';
                            item.querySelector('.discounts-freq').value = discount.frequency || 'monthly';
                        });
                    }

                    console.log('Form populated from JSON data');
                }

                function showDropZoneSuccess(message) {
                    dropZone.classList.remove('processing', 'error');
                    dropZone.classList.add('success');
                    filePreview.innerHTML = '<strong>‚úÖ Success:</strong> ' + message;
                    setTimeout(() => {
                        dropZone.classList.remove('success');
                        filePreview.classList.remove('show');
                    }, 3000);
                }

                function showDropZoneError(message) {
                    dropZone.classList.remove('processing', 'success');
                    dropZone.classList.add('error');
                    filePreview.innerHTML = '<strong>‚ùå Error:</strong> ' + message;
                    setTimeout(() => {
                        dropZone.classList.remove('error');
                        filePreview.classList.remove('show');
                    }, 5000);
                }
            }

            // Setup drag and drop after DOM is ready
            setTimeout(() => {
                setupDragAndDrop();
                console.log('Drag and drop functionality initialized');
            }, 1500);

            // ...existing error handling code...
        } catch (error) {
            console.error('=== CRITICAL APPLICATION INITIALIZATION ERROR ===');
            console.error('Error Type:', error.constructor.name);
            console.error('Error Message:', error.message);
            console.error('Error Stack:', error.stack);
            console.error('Error occurred at:', new Date().toISOString());
            
            // Try to log to AppLogger if it exists
            try {
                if (typeof AppLogger !== 'undefined' && AppLogger) {
                    AppLogger.error('App', 'Failed to initialize application', {
                        errorType: error.constructor.name,
                        errorMessage: error.message,
                        errorStack: error.stack,
                        timestamp: new Date().toISOString()
                    });
                }
            } catch (logError) {
                console.error('Failed to log to AppLogger:', logError.message);
            }
            
            // Additional debugging information
            console.error('=== DEBUG INFORMATION ===');
            console.error('Document ready state:', document.readyState);
            console.error('Window loaded:', window.document.readyState === 'complete');
            console.error('AppLogger available:', typeof AppLogger);
            console.error('ModuleRegistry available:', typeof ModuleRegistry);
            
            // Check which modules are available
            const moduleClasses = [
                'Logger', 'ModuleRegistry', 'TranslationManager', 
                'PrinterDatabase', 'AutocompleteManager', 'TemplateManager', 
                'FormManager', 'DebugPanel'
            ];
            
            console.error('=== MODULE AVAILABILITY CHECK ===');
            moduleClasses.forEach(className => {
                console.error(`${className}:`, typeof window[className]);
            });
            
            // Check if ModuleRegistry has any registered modules
            try {
                if (typeof PrinterApp !== 'undefined' && PrinterApp.moduleRegistry && PrinterApp.moduleRegistry.getRegisteredModules) {
                    const registeredModules = PrinterApp.moduleRegistry.getRegisteredModules();
                    console.error('Registered modules:', Object.keys(registeredModules));
                }
            } catch (regError) {
                console.error('Failed to check registered modules:', regError.message);
            }
            
            // Show detailed error message to user
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #dc3545; color: white; padding: 15px 25px; border-radius: 8px; z-index: 9999; font-family: Arial, sans-serif; max-width: 80%; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            errorDiv.innerHTML = `
                <strong>Application Initialization Failed</strong><br>
                <small>Error: ${error.message}</small><br>
                <small>Type: ${error.constructor.name}</small><br>
                <small style="margin-top: 10px; display: block;">
                    Please open browser console (F12) for detailed debugging information.
                    <br>Check that all JavaScript modules loaded properly.
                </small>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove error message after 10 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 10000);
        }
    });
    </script>
</body>
</html>
